<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Paper Trading Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Courier New', monospace;
      background: #f5f5f5;
      color: #1a1a1a;
      padding: 28px 32px;
      max-width: 1100px;
      margin: 0 auto;
    }

    h1 { font-size: 1.3rem; font-weight: normal; letter-spacing: 0.05em; }
    .updated { color: #888; font-size: 0.78rem; margin-top: 4px; margin-bottom: 28px; }

    /* ── Stats ── */
    .stats { display: flex; gap: 16px; margin-bottom: 36px; flex-wrap: wrap; }
    .stat-box {
      background: #fff;
      border: 1px solid #ddd;
      padding: 14px 22px;
      min-width: 170px;
    }
    .stat-label {
      color: #888;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 6px;
    }
    .stat-value { font-size: 1.5rem; }

    /* ── Chart ── */
    .section { margin-bottom: 44px; }
    .section-title {
      font-size: 0.72rem;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding-bottom: 8px;
      border-bottom: 1px solid #ddd;
      margin-bottom: 12px;
    }
    .chart-controls { display: flex; gap: 6px; margin-bottom: 10px; }
    .chart-controls button {
      background: #fff;
      border: 1px solid #ddd;
      color: #888;
      padding: 3px 11px;
      cursor: pointer;
      font-family: inherit;
      font-size: 0.8rem;
    }
    .chart-controls button:hover { color: #333; }
    .chart-controls button.active { border-color: #2e7d32; color: #2e7d32; }
    .chart-wrap {
      background: #fff;
      border: 1px solid #ddd;
      padding: 16px;
      height: 280px;
    }

    /* ── Tables ── */
    table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
    th {
      text-align: left;
      color: #888;
      font-weight: normal;
      padding: 5px 10px;
      border-bottom: 1px solid #ddd;
    }
    td { padding: 7px 10px; border-bottom: 1px solid #eee; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: #fafafa; }
    .empty { color: #aaa; font-style: italic; }

    /* ── Colors ── */
    .pos { color: #2e7d32; }
    .neg { color: #c62828; }
  </style>
</head>
<body>

  <h1>Paper Trading Dashboard</h1>
  <div class="updated" id="updated">Loading...</div>

  <div class="stats">
    <div class="stat-box">
      <div class="stat-label">Portfolio Value</div>
      <div class="stat-value" id="equity">—</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">Today's P&amp;L</div>
      <div class="stat-value" id="pnl-dollar">—</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">Today's P&amp;L %</div>
      <div class="stat-value" id="pnl-pct">—</div>
    </div>
  </div>

  <div class="section">
    <div class="section-title">Portfolio History</div>
    <div class="chart-controls">
      <button id="btn-1D" onclick="setRange('1D')">1D</button>
      <button id="btn-1M" onclick="setRange('1M')" class="active">1M</button>
      <button id="btn-6M" onclick="setRange('6M')">6M</button>
      <button id="btn-1Y" onclick="setRange('1Y')">1Y</button>
    </div>
    <div class="chart-wrap">
      <canvas id="chart"></canvas>
    </div>
  </div>

  <div class="section">
    <div class="section-title">Open Positions</div>
    <table>
      <thead>
        <tr>
          <th>Symbol</th>
          <th>Side</th>
          <th>Qty</th>
          <th>Avg Entry</th>
          <th>Current Price</th>
          <th>Market Value</th>
          <th>Unrealized P&amp;L</th>
          <th>%</th>
        </tr>
      </thead>
      <tbody id="positions-body">
        <tr><td colspan="8" class="empty">Loading...</td></tr>
      </tbody>
    </table>
  </div>

  <div class="section">
    <div class="section-title">Recent Filled Orders</div>
    <table>
      <thead>
        <tr>
          <th>Symbol</th>
          <th>Side</th>
          <th>Qty</th>
          <th>Type</th>
          <th>Fill Price</th>
          <th>Filled At</th>
        </tr>
      </thead>
      <tbody id="orders-body">
        <tr><td colspan="6" class="empty">Loading...</td></tr>
      </tbody>
    </table>
  </div>

  <script>
    let chart = null;
    let data = null;
    let range = '1M';

    const $ = id => document.getElementById(id);

    function fmt(n, dec = 2) {
      const v = parseFloat(n);
      return isNaN(v) ? '—' : v.toLocaleString('en-US', { minimumFractionDigits: dec, maximumFractionDigits: dec });
    }
    function fmtDollar(n) { return '$' + fmt(n); }
    function sign(n) { return parseFloat(n) >= 0 ? '+' : ''; }
    function colorClass(n) { return parseFloat(n) >= 0 ? 'pos' : 'neg'; }

    function setRange(r) {
      range = r;
      document.querySelectorAll('.chart-controls button').forEach(b => b.classList.remove('active'));
      $(`btn-${r}`).classList.add('active');
      if (data) renderChart();
    }

    function renderChart() {
      const h = data.history[range];
      if (!h || !h.timestamps.length) return;

      const labels = h.timestamps.map(ts => {
        const d = new Date(ts * 1000);
        if (range === '1D') {
          return d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      });

      const equity = h.equity;
      const trend = equity[equity.length - 1] >= equity[0] ? '#2e7d32' : '#c62828';

      if (chart) chart.destroy();

      chart = new Chart($('chart').getContext('2d'), {
        type: 'line',
        data: {
          labels,
          datasets: [{
            data: equity,
            borderColor: trend,
            backgroundColor: trend + '15',
            fill: true,
            tension: 0.1,
            pointRadius: 0,
            borderWidth: 1.5,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false }, tooltip: {
            callbacks: {
              label: ctx => ' $' + ctx.parsed.y.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
            }
          }},
          scales: {
            x: {
              grid: { color: '#eee' },
              ticks: { color: '#aaa', maxTicksLimit: 8, font: { family: 'Courier New', size: 10 } },
            },
            y: {
              grid: { color: '#eee' },
              ticks: {
                color: '#aaa',
                font: { family: 'Courier New', size: 10 },
                callback: v => '$' + v.toLocaleString(),
              },
            }
          }
        }
      });
    }

    function renderStats() {
      const { equity, last_equity } = data.account;
      if (equity === null) return;

      const pnlD = parseFloat(equity) - parseFloat(last_equity);
      const pnlP = pnlD / parseFloat(last_equity);

      $('equity').textContent = fmtDollar(equity);

      const de = $('pnl-dollar');
      de.textContent = (pnlD >= 0 ? '+$' : '-$') + fmt(Math.abs(pnlD));
      de.className = 'stat-value ' + colorClass(pnlD);

      const pe = $('pnl-pct');
      pe.textContent = sign(pnlP) + fmt(pnlP * 100) + '%';
      pe.className = 'stat-value ' + colorClass(pnlP);
    }

    function renderPositions() {
      const body = $('positions-body');
      if (!data.positions.length) {
        body.innerHTML = '<tr><td colspan="8" class="empty">No open positions</td></tr>';
        return;
      }
      body.innerHTML = data.positions.map(p => {
        const cls = colorClass(p.unrealized_pl);
        const pct = fmt(parseFloat(p.unrealized_plpc) * 100);
        return `<tr>
          <td><strong>${p.symbol}</strong></td>
          <td>${p.side.toUpperCase()}</td>
          <td>${fmt(p.qty, 0)}</td>
          <td>${fmtDollar(p.avg_entry_price)}</td>
          <td>${fmtDollar(p.current_price)}</td>
          <td>${fmtDollar(p.market_value)}</td>
          <td class="${cls}">${sign(p.unrealized_pl)}${fmtDollar(p.unrealized_pl)}</td>
          <td class="${cls}">${sign(p.unrealized_plpc)}${pct}%</td>
        </tr>`;
      }).join('');
    }

    function renderOrders() {
      const body = $('orders-body');
      if (!data.orders.length) {
        body.innerHTML = '<tr><td colspan="6" class="empty">No recent orders</td></tr>';
        return;
      }
      body.innerHTML = data.orders.map(o => {
        const cls = o.side === 'buy' ? 'pos' : 'neg';
        const filledAt = o.filled_at ? new Date(o.filled_at).toLocaleString() : '—';
        return `<tr>
          <td><strong>${o.symbol}</strong></td>
          <td class="${cls}">${o.side.toUpperCase()}</td>
          <td>${fmt(o.qty, 0)}</td>
          <td>${o.type.toUpperCase()}</td>
          <td>${o.filled_avg_price ? fmtDollar(o.filled_avg_price) : '—'}</td>
          <td style="color:#aaa">${filledAt}</td>
        </tr>`;
      }).join('');
    }

    async function load() {
      const res = await fetch(`./data/dashboard.json?v=${Date.now()}`);
      data = await res.json();

      if (data.updated_at) {
        $('updated').textContent = `Last updated: ${new Date(data.updated_at).toLocaleString()}`;
      } else {
        $('updated').textContent = 'Awaiting first data fetch...';
      }

      renderStats();
      renderChart();
      renderPositions();
      renderOrders();
    }

    load().catch(err => {
      console.error(err);
      $('updated').textContent = 'Error loading data.';
    });
  </script>

</body>
</html>
